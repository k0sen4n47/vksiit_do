import{i as b,a as _}from"./codemirror-editor-3972d91d.js";console.log("assignment-create.js loaded");window.clearSelection=function(){console.log("clearSelection called");const n=document.getElementById("subject-group"),e=document.getElementById("group-group");if(n){n.style.display="block";const t=n.querySelector("select");t&&(t.required=!0)}if(e){e.style.display="block";const t=e.querySelector("select");t&&(t.required=!0)}const o=document.querySelector('input[name="subject_id"][type="hidden"]'),i=document.querySelector('input[name="group_id"][type="hidden"]');o&&o.remove(),i&&i.remove();const a=document.querySelector(".assignment-create__info");a&&(a.style.display="none")};document.addEventListener("DOMContentLoaded",function(){console.log("DOM fully loaded"),window.questionCounters={},window.answerCounters={},document.addEventListener("click",function(t){if(t.target.closest(".add-question")){const r=t.target.closest(".add-question").dataset.pageIndex;console.log("Adding question for test:",r),C(r)}}),document.addEventListener("click",function(t){if(t.target.closest(".remove-question")){const r=t.target.closest(".remove-question").closest(".test-question"),l=r.closest('.assignment-create__page[data-page-type="test"]');if(!l)return;const c=l.dataset.testIndex;r.remove(),I(c)}});const n=document.getElementById("assignmentForm");n&&n.addEventListener("submit",x);let e=0;const o=document.querySelector(".assignment-create__add-page"),i=document.querySelector(".assignment-create__pages"),a=document.getElementById("textPageTemplate");o?console.log("Кнопка .assignment-create__add-page найдена"):console.error("Кнопка .assignment-create__add-page не найдена!"),i?console.log("Контейнер .assignment-create__pages найден"):console.error("Контейнер .assignment-create__pages не найден!"),a?console.log("Шаблон #textPageTemplate найден"):console.error("Шаблон #textPageTemplate не найден!"),o&&i&&a&&o.addEventListener("click",function(){console.log("add page button clicked"),k(o,function(t){e++;let s="";t==="text"&&(s="textPageTemplate"),t==="code"&&(s="codePageTemplate"),t==="test"&&(s="testPageTemplate");const r=document.getElementById(s);if(!r)return;const l=r.content.cloneNode(!0);l.querySelectorAll("[name], [for], [id], [data-page-index], [data-test-index]").forEach(c=>{c.name&&(c.name=c.name.replace(/INDEX|PAGE_INDEX/g,e)),c.htmlFor&&(c.htmlFor=c.htmlFor.replace(/INDEX|PAGE_INDEX/g,e)),c.id&&(c.id=c.id.replace(/INDEX|PAGE_INDEX/g,e)),c.dataset.pageIndex&&(c.dataset.pageIndex=e),c.dataset.testIndex!==void 0&&(c.dataset.testIndex=e)}),l.querySelectorAll("*").forEach(c=>{c.childNodes.length===1&&c.childNodes[0].nodeType===3&&(c.textContent=c.textContent.replace("[PAGE_INDEX]",e+1))}),i.appendChild(l),t==="text"&&setTimeout(()=>_(".text-editor, .tinymce-editor"),0),t==="code"&&setTimeout(()=>{const c=i.querySelector('.assignment-create__page[data-page-type="code"][data-page-index="'+e+'"]');c&&b(c)},0)})}),document.addEventListener("click",function(t){if(t.target.closest(".assignment-create__page-remove")){const r=t.target.closest(".assignment-create__page-remove").closest(".assignment-create__page");r&&r.remove()}}),document.addEventListener("click",function(t){if(t.target.closest(".add-answer")){const r=t.target.closest(".add-answer").closest(".test-question");if(!r)return;const l=r.closest('.assignment-create__page[data-page-type="test"]');if(!l)return;const c=l.dataset.testIndex,u=r.dataset.questionIndex;A(c,u)}}),document.addEventListener("click",function(t){if(t.target.closest(".remove-answer")){const s=t.target.closest(".test-answer");if(!s)return;const r=s.closest(".test-question");if(!r)return;const l=r.closest('.assignment-create__page[data-page-type="test"]');if(!l)return;const c=l.dataset.testIndex,u=r.dataset.questionIndex;s.remove(),N(c,u)}}),document.querySelectorAll(".assignment-create__edit-code").forEach(function(t){if(t.querySelector(".html-editor")&&t.querySelector(".css-editor")){const s=t.querySelector(".html-textarea"),r=t.querySelector(".css-textarea");s&&r&&setTimeout(()=>{b(t)},0)}})});async function x(n){n.preventDefault();const e=n.target,o=e.querySelector('button[type="submit"]'),i=o.textContent;try{o.disabled=!0,o.textContent="Сохранение...";const a=new FormData(e),t=E(a),r=await(await fetch("/teacher/assignments/store",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/json"},body:JSON.stringify(t)})).json();r.success?(f("success",r.message),setTimeout(()=>{window.location.href=r.redirect_url},1500)):f("error",r.message||"Произошла ошибка при сохранении задания")}catch(a){console.error("Error submitting form:",a),f("error","Произошла ошибка при сохранении задания")}finally{o.disabled=!1,o.textContent=i}}function E(n){let e=n.get("deadline");e&&e.includes("T")&&(e=e.replace("T"," "),/:\d{2}$/.test(e)||(e+=":00"));const o={subject_id:n.get("subject_id"),group_id:n.get("group_id"),title:n.get("title"),description:n.get("description"),deadline:e,max_score:parseInt(n.get("max_score"))||100,pages:[]},i=document.querySelectorAll(".assignment-create__page");let a=!1,t="";if(i.forEach((s,r)=>{const l=s.dataset.pageType;let c="",u="";if(l==="text")c=s.querySelector('input[name*="[title]"]').value,u=s.querySelector('textarea[name*="[content]"]').value,c||(a=!0,t="У текстовой страницы нет заголовка");else if(l==="code"){c=s.querySelector('input[name*="[title]"]').value;const d=s.querySelector('textarea[name*="[html]"]'),m=s.querySelector('textarea[name*="[css]"]');!d||!m?(console.error("HTML или CSS поля не найдены в странице с кодом"),a=!0,t="Ошибка: поля HTML или CSS не найдены"):u=JSON.stringify({html:d.value,css:m.value}),c||(a=!0,t="У страницы с кодом нет заголовка")}else l==="test"&&(c=s.querySelector('input[name*="[title]"]').value,u=s.querySelector('textarea[name*="[description]"]').value,c||(a=!0,t="У тестовой страницы нет заголовка"));const p={type:l,title:c,order:r+1,content:u};if(l==="test"){const d=T(s);d.error?(a=!0,t=d.error):p.test=d}a||o.pages.push(p)}),a)throw f("error",t),new Error(t);return o}function T(n){var i,a,t,s,r;const e={title:n.querySelector('input[name*="[title]"]').value,description:((i=n.querySelector('textarea[name*="[description]"]'))==null?void 0:i.value)||"",time_limit:((a=n.querySelector('input[name*="[time_limit]"]'))==null?void 0:a.value)||null,passing_score:parseInt(n.querySelector('input[name*="[passing_score]"]').value),max_attempts:((t=n.querySelector('input[name*="[max_attempts]"]'))==null?void 0:t.value)||null,shuffle_questions:((s=n.querySelector('input[name*="[shuffle_questions]"]'))==null?void 0:s.checked)||!1,show_results:((r=n.querySelector('input[name*="[show_results]"]'))==null?void 0:r.checked)||!0,questions:[]};if(!e.title)return{error:"У теста нет названия"};if(!e.passing_score||isNaN(e.passing_score))return{error:"У теста не указан проходной балл"};const o=n.querySelectorAll(".test-question");return o.length===0?{error:"В тесте должен быть хотя бы один вопрос"}:(o.forEach((l,c)=>{const u=l.querySelector(".question-type").value,p=l.querySelector(".question-text").value,d=parseInt(l.querySelector(".question-score").value);if(!p||!d||isNaN(d))return;const m={question_text:p,type:u,points:d};if(u==="single"||u==="multiple"){const g=l.querySelectorAll(".test-answer");if(g.length===0){e.error=`Вопрос №${c+1} должен содержать хотя бы один ответ`;return}let y=!1;if(m.answers=[],g.forEach(q=>{var w;const S=q.querySelector(".answer-text").value,h=((w=q.querySelector(".answer-correct"))==null?void 0:w.checked)||!1;h&&(y=!0),S&&m.answers.push({answer_text:S,is_correct:h})}),!y){e.error=`В вопросе №${c+1} не отмечен правильный ответ`;return}}e.questions.push(m)}),e.questions.length===0?{error:"В тесте нет валидных вопросов"}:e.error?{error:e.error}:e)}function f(n,e){const o=document.getElementById("alertContainer")||v(),a=`
        <div class="alert ${n==="success"?"alert-success":"alert-danger"} alert-dismissible fade show" role="alert">
            ${e}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;o.innerHTML=a,o.style.display="block",setTimeout(()=>{o.style.display="none"},5e3)}function v(){const n=document.createElement("div");return n.id="alertContainer",n.style.position="fixed",n.style.top="20px",n.style.right="20px",n.style.zIndex="9999",n.style.display="none",document.body.appendChild(n),n}function C(n){console.log("Creating question for test:",n);const e=document.querySelector(`[data-test-index="${n}"]`);if(!e){console.error("Test container not found");return}const o=e.querySelector(".questions-container");if(!o){console.error("Questions container not found");return}const i=o.children.length,a=document.getElementById("question-template");if(!a){console.error("Question template not found");return}const s=a.content.cloneNode(!0).querySelector(".test-question");s.dataset.questionIndex=i;const r=s.querySelector(".question-number");r&&(r.textContent=i+1);const l=s.querySelector('input[type="text"]');l&&!l.classList.contains("question-text")&&l.classList.add("question-text");const c=s.querySelector("select");c&&!c.classList.contains("question-type")&&c.classList.add("question-type");const u=s.querySelector('input[type="number"]');u&&!u.classList.contains("question-score")&&u.classList.add("question-score"),o.appendChild(s)}function A(n,e){console.log("Adding answer for question:",e,"in test:",n),window.answerCounters[n]||(window.answerCounters[n]={}),window.answerCounters[n][e]||(window.answerCounters[n][e]=0);const o=window.answerCounters[n][e]++,i=document.getElementById("answer-template");if(!i){console.error("Answer template not found");return}const a=i.innerHTML.replace(/\[TEST_INDEX\]/g,n).replace(/\[QUESTION_INDEX\]/g,e).replace(/\[ANSWER_INDEX\]/g,o),t=document.querySelector(`[data-test-index="${n}"] .test-question:nth-child(${e+1})`);if(!t){console.error("Question not found:",e);return}let s=t.querySelector(".answers-container");if(s||(s=t.querySelector(".test-answers__container")),!s){console.error("Answers container not found for question:",e);return}s.insertAdjacentHTML("beforeend",a);const r=s.lastElementChild.querySelector(".form-check-input");r&&r.addEventListener("change",L)}function I(n){const e=document.querySelector(`[data-test-index="${n}"]`);if(!e)return;e.querySelectorAll(".test-question").forEach((i,a)=>{const t=i.querySelector(".question-number");t&&(t.textContent=a+1),i.dataset.questionIndex=a,i.querySelectorAll('[name*="questions["]').forEach(s=>{const r=s.name.replace(/questions\[\d+\]/,`questions[${a}]`);s.name=r})})}function N(n,e){const o=document.querySelector(`[data-test-index="${n}"] .test-question:nth-child(${e+1})`);if(!o)return;o.querySelectorAll(".test-answer").forEach((a,t)=>{const s=a.querySelector("h5");s&&(s.textContent=`Ответ ${t+1}`),a.querySelectorAll('[name*="answers]"]').forEach(r=>{r.name=r.name.replace(/answers\[\d+\]/,`answers[${t}]`)})})}function L(n){const e=n.target.closest(".test-answer"),o=e.closest(".test-question");o.querySelector(".question-type").value==="single"&&o.querySelectorAll(".test-answer").forEach(t=>{if(t!==e){t.classList.remove("correct");const s=t.querySelector(".form-check-input");s&&(s.checked=!1)}}),n.target.checked?e.classList.add("correct"):e.classList.remove("correct")}function k(n,e){if(document.getElementById("pageTypeSelector"))return;const o=document.createElement("div");o.id="pageTypeSelector",o.style.marginTop="10px",o.innerHTML=`
        <button type="button" class="btn-cabinet" data-type="code">Код</button>
        <button type="button" class="btn-cabinet" data-type="text">Текст</button>
        <button type="button" class="btn-cabinet" data-type="test">Тест</button>
        <button type="button" class="btn-cabinet" id="cancelPageType">Отмена</button>
    `;const i=document.querySelector(".assignment-create__pages");i?i.appendChild(o):n.parentNode.insertBefore(o,n.nextSibling),o.querySelectorAll("button[data-type]").forEach(a=>{a.onclick=function(){e(a.getAttribute("data-type")),o.remove()}}),o.querySelector("#cancelPageType").onclick=function(){o.remove()}}
